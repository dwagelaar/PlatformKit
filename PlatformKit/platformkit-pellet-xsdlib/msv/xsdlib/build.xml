<?xml version="1.0"?>
<!--
	Ant build script for XSDLib.
	
	$Id: build.xml,v 1.13 2003/08/07 17:32:20 kohsuke Exp $
	
	
	
	Tasks to help development
	=========================
	javacc
		run JavaCC
	binary
		compile everything to the bin directory.
	javadoc
		run javadoc on the working copy. Useful to check the documentation
		without actually creating a distribution package.
	test
		test core msv codes. parser, verifier and several related codes.
	release
		create a distribution package
	
-->
<project name="xsdlib" basedir="." default="binary">
	
	<!-- import the global configuration file -->
	<property file="../shared/ant.config"/>
	
	<target name="clean" description="remove all the generated files">
		<delete dir="bin" />
		<delete dir="dist" />
		<delete dir="javadoc" />
		<delete dir="temp" />
		<!-- TODO: delete JavaCC generated files -->
	</target>
	
	
	<!-- compile Java source files -->
	<target name="binary" depends="javacc">
		<mkdir dir="./bin"/>
		<javac
			srcdir="./src:./test"
			destdir="./bin"
			debug="on"
			optimize="off"
			classpath="${xerces.jar}:${relaxngDatatype.jar}:${junit.jar}:${jdom.jar}:${isorelax.jar}:${xalan.jar}"
			/>
	</target>
	
	
		<!-- internal task -->
		<target name="doJavacc">
			<!-- check if javacc needs to run -->
			<uptodate property="iso8601.uptodate"
				targetfile="${src}/com/sun/msv/datatype/xsd/datetime/ISO8601Parser.java">
				<srcfiles dir="${src}/com/sun/msv/datatype/xsd/datetime"
					includes="ISO8601.jj"/>
			</uptodate>
			<antcall target="doJavacc.sub"/>
		</target>
		
		<target name="doJavacc.sub" unless="iso8601.uptodate">
			<javacc	target="${src}/com/sun/msv/datatype/xsd/datetime/ISO8601.jj"
					outputdirectory="${src}/com/sun/msv/datatype/xsd/datetime"
					javacchome="${javaCClib}"
			/>
		</target>
	
	<!-- run javacc -->
	<target name="javacc">
		<antcall target="doJavacc">
			<param name="src" value="./src" />
		</antcall>
	</target>
	
	<!-- generate javadoc documentation from the working copy -->
	<target name="javadoc">
		<mkdir dir="./javadoc"/>
		<javadoc	locale="en_US"
					packagenames="com.sun.msv.*"
					sourcepath="./src"
					classpath="${java.class.path}"
					destdir="./javadoc"
					windowtitle="XSDLib (private build)"
					public="yes"
					author="yes"
					overview="src/com/sun/msv/overview.html"
					>
			<link offline="true" href="http://java.sun.com/products/jdk/1.2/docs/api"
				packagelistLoc="../shared/ExternalPackageLists/CoreAPI" />
			<link offline="true" href="http://xml.apache.org/apiDocs/"
				packagelistLoc="../shared/ExternalPackageLists/XML" />
			<link offline="true" href="http://iso-relax.sourceforge.net/apiDoc/"
				packagelistLoc="../shared/ExternalPackageLists/ISO-RELAX" />
			<link offline="true" href="http://relaxng.sourceforge.net/datatype/java/apiDocs/"
				packagelistLoc="../shared/ExternalPackageLists/RELAXNG" />
		</javadoc>
	</target>
	
	
	
	
	
	
	<!-- test the working directory -->
	<target name="test">
		<ant antfile="../shared/ant.test.xml" target="test" />
	</target>
	
	
	
	
	
	<!-- test the distribution package -->
	<target name="test_release">
		<ant antfile="../shared/ant.test.xml" target="test_release">
			<property name="testJar" value="../package/xsdlib.jar"/>
		</ant>
	</target>
	
	
	
	
	<!-- generate XSDLib release -->
	<target name="dist" description="build the distribution package into the dist/ dir">
    <tstamp>
      <format property="YEAR" pattern="yyyy" locale="en"/>
    </tstamp>
		
		<delete	dir="dist" />
		
		<!-- copy source/example code -->
		<copy todir="dist/src">
			<fileset dir="src"/>
		</copy>
		<copy todir="dist/examples">
			<fileset dir="examples" />
		</copy>
		
		<!-- copy document files -->
		<copy todir="dist">
			<fileset dir="doc" />
		</copy>
    <replace dir="dist">
        <include name="**/*.html"/>
        <include name="**/*.txt"/>
        <replacefilter token="@@VERSION@@" value="${DSTAMP}" />
        <replacefilter token="@@YEAR@@" value="${YEAR}" />
    </replace>
		
		
		<!-- run javacc -->
		<antcall target="doJavacc">
			<param name="src" value="dist/src" />
		</antcall>
		
		
		<!-- compile files -->
		<mkdir	dir="temp" />
		<javac	srcdir="dist/src" destdir="temp" debug="on">
			
			<classpath path="${relaxngDatatype.jar}"/>
			<include name="**/*.java" />
		</javac>
		
		
		<!-- create a time stamp file -->
		<echo file="temp/version.properties">version=${DSTAMP}</echo>
		
		<!-- create META-INF/services file -->
		<mkdir dir="temp/META-INF/services"/>
		<echo file="temp/META-INF/services/org.relaxng.datatype.DatatypeLibraryFactory"
			>com.sun.msv.datatype.xsd.ngimpl.DataTypeLibraryImpl</echo>
		
		<!-- creates binary jar -->
		<jar	jarfile="dist/xsdlib.jar"
				manifest="./MANIFEST.MF"
				compress="${compress}">
			<fileset dir="temp" />
			<!-- resource files -->
			<fileset dir="dist/src" includes="**/*.properties" />
		</jar>
		<delete dir="temp" />
		<delete dir="xerces"/>
		
		
		<!-- creates javadoc -->
		<mkdir		dir="dist/javadoc" />
		<javadoc	locale="en_US"
					packagenames="com.sun.msv.*"
					sourcepath="dist/src"
					destdir="dist/javadoc"
					windowtitle="Sun XML Datatypes Library"
					public="yes"
					author="yes"
					>
			<link offline="true" href="http://java.sun.com/products/jdk/1.2/docs/api"
				packagelistLoc="../shared/ExternalPackageLists/CoreAPI" />
			<link offline="true" href="http://xml.apache.org/apiDocs/"
				packagelistLoc="../shared/ExternalPackageLists/XML" />
			<link offline="true" href="http://relaxng.sourceforge.net/datatype/java/apiDocs/"
				packagelistLoc="../shared/ExternalPackageLists/RELAXNG" />
		</javadoc>
		
		<!-- copy additional jar files -->
		<copy file="${relaxngDatatype.jar}" tofile="dist/relaxngDatatype.jar" />
	</target>
	
	<target name="release" depends="dist" description="build the distribution zip file">
    <tstamp />
		<property name="stageName" value="xsdlib-${DSTAMP}"/>
		
		<!-- copy jar file to package dir -->
		<copy file="dist/xsdlib.jar" tofile="../package/xsdlib.jar" />
    
    <!-- build src zip file -->
    <zip zipfile="../package/xsdlib-src.zip" compress="true">
      <fileset dir="dist/src" />
    </zip>
		
		<!-- creates distribution package -->
		<mkdir dir="../package"/>
		<zip	zipfile="../package/xsdlib.${DSTAMP}.zip">
			<zipfileset dir="dist" includes="**/*.*" prefix="${stageName}" />
		</zip>
	</target>
</project>
